---
layout: post
title: "毕设记录（一）"
description: ""
date: 2022-10-22
feature_image: images/2022.10.22/0.png
tags: [毕设]
---

<!--more-->

## 系统构成

- 干扰弹：动作行为、模型材质、外观呈现 -> 可以被上级对象生成并发射 -> 间接操作对象
- 导弹 -> 间接操作对象
- 飞机 -> 用户可直接操作对象
- 环境：地形、天空、光照、云雾 

我将系统一共看成了六个部分，对象是场景中直接可见可操作的一些物体，如干扰弹、战机、环境，世界管理器管理并更新着所有对象，在启动时先从配置管理器获取场景中对象的配置初始化仿真计算器并初始化对象，然后每帧获取仿真计算器的仿真结果并赋予给场景中对象。世界管理器可以打开配置编辑器，根据配置管理器中的一些设置，提供用户可以自定义编辑配置的工具。配置管理器在系统启动时会首先查看内置配置库加载已有配置。

![](../images/2022.10.22/0.png)

## 对局流程

![](../images/2022.10.22/1.png)

## 新增配置

系统的可配置性关键在于类的抽象设计要足够通用，规定一套统一的 API 供用户续写，这里让用户编译成 dll 最方便，也可以预先设定一些行为逻辑供用户组合生成新的行为逻辑，比如运动模型，那就要把 update 接口留出来，输出是下一帧的运动状态，这样就可以继承出多种运动模型，可以实现自己的运算逻辑，输入输出定义好，初始化接口留出来，这样世界管理器只需要一开始调用一个初始化函数，之后每帧调用更新函数即可。

如果要变成分布式系统，那么现有系统也很容易扩展，因为这些管理器计算器其实不局限于所在哪台机器，它们也可以在服务器上部署，只不过还是得有一个总的调度器来管理不同对局，然后分发到不同用户上独立的管理器中。在计算时需要加上标识，说明是哪个地址的服务。同时世界管理器需要多一点同步操作。

## 开题报告

收集了一些相关的论文资料，东西比较杂乱，后续会整理。

- 刘延峰. 基于OpenGL的实时红外图像仿真引擎设计与实现[D].西安电子科技大学,2021.DOI:10.27389/d.cnki.gxadu.2021.000738.
- 传统的基于外场的红外图像获取方法和基于半实物的红外图像仿真方法往往无法快速、廉价的提供大量特定环境下的红外图像，因此基于计算机的红外仿真技术受到越来越多的关注。红外仿真技术就是通过分析实际红外成像系统的工作方式并使用计算机重现这一过程以生成满足需求的红外图像，这种方式可以有效避免利用实场获取红外图像工作量大、花费高、灵活性差等问题，具有非常大的军事与民用价值。 
- 本文以构建一个轻量易用的实时红外图像仿真引擎为目标，紧密围绕实时性这一要求，以战斗机三维模型作为主要研究对象，通过分析红外成像系统的基本物理原理，结合计算机图形学、图像处理、软件工程等领域的技术，对红外成像系统的各个关键环节进行了研究，主要工作包括：（1）研究了红外成像系统的基本物理原理，分析了影响红外成像系统的常见因素，包括独立热源、大气传输效应、太阳、遮挡、成像设备，对以上物理原理和影响因素一一建模，忽略次要因素提取主要特征，奠定本文后续提出的红外仿真数学模型的合理性和实时性。（2）通过分析仿真中各个环节的具体工作任务，对CPU和GPU进行了合理的任务分配和调度，结合OpenGL和GLSL语言构建了一套基于GPU的红外仿真系统框架。与实场拍摄的红外图像和其他红外仿真方法对比，本文的仿真图像灰度分布与实际红外图像分布基本一致，仿真速度也快于其他仿真方法。（3）针对飞机尾焰的实时红外图像仿真，提出了一种结合尾焰建模与C-G谱带法的GPU尾焰红外仿真方法。在此基础上还提出了一种基于单参数控制的尾焰网格实时更新的动态尾焰仿真方法，该方法通过控制单一参数使得尾焰模型各个顶点在GPU上独立并行的调整其空间位置以实现实时更新尾焰，从而获得尾焰扰动的逼真效果。实验结果表明，本文提出的方法可以快速、有效的仿真出飞机尾焰的红外图像。（4）针对目前国内红外图像仿真软件以及专用的红外图像仿真引擎较少的问题，依靠OpenGL与C++编程语言，结合面向对象编程思想，构造了一个轻量、专用、接口清晰、扩展性强、低耦合高内聚的红外仿真引擎。并利用此引擎二次开发了一个基于GPU的激光仿真引擎和红外仿真软件。 
- 红外成像系统具有可全天候工作、设备轻便、抗烟雾干扰能力强等特点在军事与民用领域有着广阔的应用。在军事中可以进行红外侦查、红外夜视、红外制导、红外光电对抗等。民用领域中可以进行红外测温、红外成像探伤、红外医疗等。红外图像仿真技术基于红外物理学、光学、图像处理、计算机图形学等多门学科。原理上讲红外探测器接收到目标以及背景自身或者反射的特定波段的辐射，这些辐射受到大气、成像系统等影响后传入探测器，探测器将辐射通过光电信号的转换生成最终的图像。基于数学模型的红外成像仿真技术以三维数字模型为研究对象，通过分析物体表面温度分布、红外辐射量化、成像信号转换、大气环境衰减等红外成像链路中关键步骤的物理特性并对这些过程一一建模，再利用计算机完整的模拟上述整个步骤，最后结合现代计算机中强大的硬件设备，利用计算机图形学相关领域的技术准确、快速的给出符合需求的红外图像。为了快速获取大量的红外图像，使用计算机去进行红外图像的仿真是十分必要的，而随着硬件的进步与计算机技术的发展，这种仿真方法更加快捷、先进，因此依据计算机去模拟仿真红外图像具有很大的现实意义和应用前景。
- 对飞行器等空中目标的红外仿真研究主要集中在两个方面，分别是蒙皮与尾焰。对于蒙皮来说仿真理论基础基本上都是基于热力学传播定律进行温度场求解。对于尾焰部分的仿真，大部分学者使用软件进行流体建模与红外仿真。对于基于光栅化的实时红外仿真技术来说，这种方法利用现有图形API并结合现代GPU的强大性能，快速且尽可能真实的将红外图像实时的仿真出来；而另外一种是离线红外仿真，即不考虑耗时，尽可能的考虑红外仿真精度，这种方法代表的技术有光线追踪等。但是随着硬件技术的发展与计算机图形学等学科的发展，这两种技术都有着一种融合的趋势，即在实时仿真技术中适当的使用一些离线仿真的技术以提高仿真精度，而在离线仿真中适当的使用GPU等进行加速仿真。
- 本文以战斗机模型为研究对象，考虑大气辐射、独立热源、速度、尾焰、太阳等的影响，主要做了以下几点工作：（1）结合红外辐射基本原理，考虑太阳、大气、阴影遮挡、独立热源、飞行器蒙皮效应等条件，构建了一个完整的基于OpenGL的飞机实时红外仿真框架，该框架将全部的红外计算以及后期的图像处理全部放入GPU中去进行处理，可以达到很高的仿真速率和较为理想的红外仿真结果。另外在计算温度与辐射时没有采用传统的基于三角形面片的辐射计算，而是采用了基于顶点的计算方法，可以有效地避免网格化现象。（2）提出了一种结合尾焰建模与C-G谱带法的GPU尾焰红外仿真方法。在此基础上还提出了一种基于单参数尾焰网格实时更新的动态尾焰仿真方法，该方法通过CPU控制单一参数使得尾焰模型各个顶点可以在GPU上独立并行的调整其空间位置以实现实时更新尾焰，从而获得尾焰扰动的逼真效果。（3）利用C++与OpenGL设计一款红外仿真渲染引擎，该引擎封装了本文的所有算法。本引擎具有的跨平台、扩展性强、使用简单等特点可以使得用户简单、方便的进行实际项目的开发，有效的降低了开发难度。
- 红外探测器通过接受目标和背景在特定波段下的辐射，将其量化并最终生成红外图像。在这一过程中探测器接收到的辐射会受到各种各样的影响，红外仿真就是通过分析量化各种因素对探测器接受到的辐射的影响，并计算出探测器接受到的具体辐射量。因此掌握红外辐射相关理论对研究红外仿真技术是必不可少的。
- 现实生活中，任何物体都在向外界辐射电磁波，这些电磁波在红外波段则属于红外线。对于一个有温度的物体而言，红外热成像仪接收到的红外辐射主要来自于三个方面。第一种就是最典型的自发辐射，这种辐射是由于物体具有温度从而不断地向外部辐射能量；第二种是物体表面反射的一部分外界辐射，这些辐射主要来自于太阳辐射与环境辐射的反射；第三种则是红外热成像仪本身也会接收到一部分由于大气介质效应产生的大气程辐射。这些辐射经过大气后传输到红外热成像仪中最终生成红外图像。

![](../images/2022.10.22/2.png)

（目标红外辐射特性）

- （物体自身辐射）普朗克定律->给定的温度下单位面积的黑体在单位时间和单位波长内辐射出的能量；斯蒂芬·玻尔兹曼定律->理想黑体单位面积与时间内辐射的能量与温度的四次方成正比。该公式说明了理想黑体辐射的能量只与波段与温度有关，而与其他条件如材质等无关；一般来说生活中的所有物体是达不到理想黑体的光谱辐射出度的，为了具体量化不同物体辐射能力的大小，我们用相同温度下物体辐出度与黑体辐出度之比来定义物体的红外发射率，生活中的大部分物体在一定波段范围内都不会发生变化，在计算时可以带入材料的平均发射率进行计算；维恩-位移定律->维恩-位移定律是针对绝对黑体的定律，该定律指出黑体的温度与此温度下的红外辐射最大值所对应波长的乘积为常数，维恩-位移定律指出当温度降低时，绝对黑体的红外辐射最大值对应的波长向长波方向移动，维恩-位移定律为红外探测奠定了基础。对于温度较高的物体，其辐射主要集中在短波区域，对于温度较高的物体，辐射集中在中长波波段。因此在观测某些大气层外的高速飞行目标时，一般使用短波红外探测器，因为空中目标的尾焰温度极高，其红外辐射主要集中短波部分；空中目标的尾焰、尾喷口和其他外露在外的金属喷管等部分温度都比较高，其红外辐射均集中在短波波段；蒙皮的温度比较低，所以集中在中长波波段。
- （反射辐射）理论上讲每个有温度的物体都是辐射源，这些辐射到达目标表面后会存在反射。这些反射辐射在特定的角度下会进入到红外探测器中，就会将效果叠加到最终的红外图像上。 一般的，反射可以分为漫反射与镜面反射。
- （物体零视距辐射度）

![](../images/2022.10.22/3.png)

（环境红外辐射特性）

- 红外探测器可观测的对象不仅仅只有目标，除去目标外还有环境辐射会对最终的红外图像造成影响。一般来说大部分的环境红外辐射都是可以测量的，它们的空间特性、光谱特性、时间特性均揭示了环境的固有属性。研究环境红外辐射特性可以为红外系统仿真提供物理特征和数学模型，为红外仿真提供提供理论基础。环境辐射可以来自于地物、海面、天空等。一般来说最常见的环境辐射源是来自天空的辐射，而天空辐射的主要来源是太阳辐射。
- （太阳辐射计算）直接来自于太阳，进过大气衰减后再次经过物体表面反射到达红外传感器中。这部分的计算需要结合物体表面红外吸收、反射等各种数据进行计算。来自于太阳，但是没有经过目标反射而是直接到达红外探测器。在计算时直接使用太阳常数与摄像机看向方向与太阳直射方向的夹角的余弦的积来表示。
- （大气传输模型）大气对红外辐射的影响主要在两方面，分别为衰减和叠加。导致衰减的原因是大气中的某些成分（二氧化碳、水蒸气、雾霾等）对光线产生了折射、反射，使得最终探测器接收到的光线能量下降；导致叠加的原因是红外辐射在传输过程中与其他反射、折射的红外辐射叠加。本文只考虑大气衰减效应。比尔定律

![](../images/2022.10.22/4.png)

（飞机红外特性）

- 对于正在空中飞行的飞机来说，主要影响其红外特性的为蒙皮效应和独立热源。（1）蒙皮效应：飞机在飞行时由于大气摩擦等影响会导致蒙皮温度上升，是影响飞机红外成像的一个关键因素；（2）独立热源，对于飞机来说，其尾焰会有很高的温度，这就导致其本身会向外辐射较多的热辐射；另一方面，高温尾焰还会影响蒙皮，导致越靠近热源的地方温度越高，从而影响最终的成像结果。 
- （蒙皮效应）飞机在高速飞行中与大气的摩擦也会对物体产生热量，对于飞机来说，其蒙皮温度还受到独立热源的影响，其内部热源可以抽象的简化为一个或多个点

![](../images/2022.10.22/5.png)

- （尾焰红外辐射原理）对于飞机来说，其发动机具有相当高的温度，一般可以达到上千摄氏度，是飞机等空中目标重要的辐射源。飞机发动机辐射主要包含两部分：尾喷管和尾焰部分。对于尾焰部分，目前主要计算尾焰辐射方法有热流法、有限体积法、离散坐标法、C-G谱带传输法。由于本文提出的引擎具有一定的实时性要求，因此本文采用C-G谱带传输法作为尾焰红外计算方法。

![](../images/2022.10.22/6.png)

（三维空间变换）

- 空间中的一个点最终变换到二维坐标上

![](../images/2022.10.22/7.png)

- （基于顶点的温度与辐射计算）令dQ=0，就可以解出模型的稳态温度分布。采用基于顶点的温度计算方法。其基本思想为对于每一个三角形面片，只计算该三角形三个顶点上的温度，三角形上的其他点则通过这三个顶点的温度与这个点的重心坐标求得。求出温度分布后，对于不同的波段，采用拟合辐射方程这一方法，将不同波段下的辐射方程拟合为k·T^s形式，以降低辐射量化时的运算量。
- （太阳光线可达性计算）将太阳作为相机去观察目标，然后将顶点的深度值写入深度贴图中。比较1K是否大于2K，若是，则认为该顶点太阳光线不可达，否则可达。判断一个顶点是否太阳光线可达，只需要在红外计算前获取一张太阳光线空间变换下的深度贴图。从频域的角度去理解，我们在将数据映射到图像中实质上就是一个下采样的过程，当图像分辨率较低时（即采样频率较低），由奈奎斯特采样定理可知此时会导致频谱混叠，表现在图像上即为观察到的锯齿现象。解决上述问题最直观的方法为增大采样频率，即增大最终投影图像的大小。
- （大气模型）平均大气透过率。仿真过程中再使用GPU查表法得出最终的大气衰减、大气辐射通量等参数。在仿真开始时，预先计算出不同海拔、天顶角、距离下的大气衰减参数，并将保存为纹理数据传入GPU中，每次渲染周期可以直接从纹理数据中读取大气透过率数据。这样就避免了在每次渲染的时候都需要重新计算一次大气透过率的问题。纹理的形式可以使用3通道32位浮点型纹理来保存，三个通道分别为短波、中波、长波的平均透过率，纹理的高与宽分别为探测器的天顶角与探测器的海拔高度。每次渲染时计算当前的探测器与目标的距离、探测器的海拔高度、探测器与顶点的天顶角。然后通过线性插值的方法计算出其最终的透过率。对于大气辐通量来说，采用同样的方法进行计算即可，这种方法可以较好的平衡速度与效果。
- （探测器成像模型）经过温度计算、辐射量化、大气模型计算后，热辐射到达红外探测器。经过一些光电效应变换后生成最终的红外图像。这其中主要包括两部分：光学系统模型与探测器模型。一般来说光学系统模型对成像的影响主要在两个方面，一方面是几何透视投影，另一方面是弥散效应。探测器模型主要负责灰度级的量化。这里假设探测器接受到的辐射亮度到最终像素的灰度级的量化关系为线性的。

![](../images/2022.10.22/8.png)

![](../images/2022.10.22/9.png)

- （基于GPU的实时红外仿真框架）任务初始化是为了提前计算或处理一些在整个仿真任务中都不发生改变的数据，如模型数据、场景数据、大气模型数据等，这些数据的计算通常都是比较耗时的，将这些数据提前进行处理能够保证在后续的仿真周期中快速的使用这些处理好的数据，提高仿真速度。红外仿真部分（包括温度计算、辐射量化、大阳光可达性计算、大气模型计算、探测器模型等）完全在GPU上进行处理，但是也有一小部分在CPU上进行处理（图3.15中的调整参数），比如最直观的每次渲染周期内目标与探测器在姿态与位置上都会发生该变，即每次渲染周期都要对每个顶点进行一次与上一个渲染周期不同的数学变换，但是这对每个顶点来说是相同的。
- （基于几何建模的尾焰）对于飞机尾焰来说，其形状一般不规则，但是还是需要用一个函数来描述其基本形态，通过观察可以知道，尾焰的形态类似于弓形，因此可以使用余弦函数或者二次函数来表示。在计算尾焰上的每个点的辐射时，仅仅与路径以及尾焰内部热量分布有关，因此十分适合采用GPU去进行计算，即将尾焰上的每个点独立并行的进行计算以提高效率。在计算该点具体发射的幅亮度时需要知道视线在尾焰内的具体长度和起点与终点，因此需要计算视线与尾焰的交点。然而在计算交点前，先要解决尾焰模型偏移的问题。






## 小结




## References

- [Building a Scalable AAA Game Engine (Presented by Amazon Lumberyard)](https://gdcvault.com/play/1024276/Building-a-Scalable-AAA-Game)